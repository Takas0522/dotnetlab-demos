---
title: 設計: Points API と DB モデル確定
assignee: dev
effort: medium
dependencies: ["設計: 認証サービスにユーザーIDクレームとロール追加"]
---

## 概要
Points サービスの API 契約と DB モデル（`PointsAllocations`, `PointsTransactions`, `PointsBalances`）を確定します。有効期限は付与日から正確に `180日`（6ヶ月相当）とします。消費は FIFO（古い付与から消費）で、部分消費をサポートします。

## 説明
- API のエンドポイント（付与、消費、残高参照、履歴参照、管理調整）を定義します。
- DB スキーマは監査と高速読み取りを考慮して設計します（Balances テーブルをキャッシュとして利用）。
- トランザクション設計は DB レベルのトランザクションと行ロックを用いて競合を防ぎます。
- 失効は日次バッチで判定し、`expired` ステータスに更新してトランザクション履歴を残します。

## 受け入れ基準
- API スペック（HTTP メソッド、パス、リクエスト/レスポンス サンプル）が作成されていること。
- DB マイグレーション用のスキーマ定義（DDL）案があること。
- トランザクション（FIFO 消費、部分消費）処理のフローチャートまたはシーケンス図があること。

## 備考
- 失効基準は `ExpiresAt <= UTC Now` として処理。トランザクション本体は削除しない（履歴保持）。
