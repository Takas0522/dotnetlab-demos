name: Auto Label Issues

on:
  issues:
    types: [opened]

jobs:
  auto-label:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Collect Code Context
        run: |
          echo "Collecting code context..."
          mkdir -p context
          
          # Broken pipeã‚¨ãƒ©ãƒ¼ã‚’é˜²ããŸã‚ã€ç›´æ¥ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦åé›†
          echo "=== PROJECT STRUCTURE ===" > context/code_context.txt
          find src -type f \( -name "*.cs" -o -name "*.ts" -o -name "*.js" -o -name "*.json" -o -name "*.sql" -o -name "*.md" \) | head -20 >> context/code_context.txt
          
          echo -e "\n=== CODE CONTENT ===" >> context/code_context.txt
          
          # é‡è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’å„ªå…ˆã—ã¦åé›†ï¼ˆBroken pipeã‚’å›é¿ï¼‰
          for file in $(find src -type f \( -name "*.cs" -o -name "*.ts" -o -name "*.js" \) | head -10); do
            if [ -f "$file" ]; then
              echo -e "\n--- $file ---" >> context/code_context.txt
              # ãƒ‘ã‚¤ãƒ—ã‚’ä½¿ã‚ãšã«ç›´æ¥headå‡¦ç†
              head -n 30 "$file" >> context/code_context.txt 2>/dev/null || true
            fi
          done
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’åˆ¶é™ï¼ˆ4KBä»¥å†…ï¼‰
          if [ -f context/code_context.txt ]; then
            head -c 4000 context/code_context.txt > context/code_summary.txt
            echo "Code context collected. Size: $(wc -c < context/code_summary.txt) bytes"
          else
            echo "No code context available" > context/code_summary.txt
          fi

      - name: Get Repository Labels
        id: get-labels
        run: |
          echo "Fetching repository labels..."
          
          # GitHub APIã‹ã‚‰ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ©ãƒ™ãƒ«ä¸€è¦§ã‚’å–å¾—
          curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github.v3+json" \
               "https://api.github.com/repos/${{ github.repository }}/labels" > labels.json
          
          # ãƒ©ãƒ™ãƒ«æƒ…å ±ã‚’æ•´ç†ï¼ˆåå‰ã¨èª¬æ˜ã‚’å«ã‚€ï¼‰
          jq -r '.[] | "\(.name): \(.description // "èª¬æ˜ãªã—")"' labels.json > labels_list.txt
          
          echo "Available labels:"
          cat labels_list.txt
          
          # ãƒ©ãƒ™ãƒ«ä¸€è¦§ã‚’ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã§ä¿å­˜
          LABELS_TEXT=$(cat labels_list.txt)
          echo "labels_text<<EOF" >> $GITHUB_OUTPUT
          echo "$LABELS_TEXT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Analyze Issue with Azure OpenAI
        id: analyze-issue
        run: |
          echo "Analyzing issue content with Azure OpenAI..."
          
          # ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
          echo "AZURE_OPENAI_ENDPOINT: ${AZURE_OPENAI_ENDPOINT:0:20}..."
          echo "AZURE_OPENAI_DEPLOYMENT: $AZURE_OPENAI_DEPLOYMENT"
          echo "AZURE_OPENAI_API_VERSION: $AZURE_OPENAI_API_VERSION"
          echo "ISSUE_TITLE: ${ISSUE_TITLE:0:50}..."
          echo "ISSUE_BODY length: ${#ISSUE_BODY}"
          
          # ã‚³ãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å®‰å…¨ã«èª­ã¿å–ã‚Šï¼ˆBroken pipeã‚’å›é¿ï¼‰
          if [ -f context/code_summary.txt ]; then
            CODE_CONTEXT=$(cat context/code_summary.txt)
            echo "Code context loaded. Length: ${#CODE_CONTEXT}"
          else
            CODE_CONTEXT="No code context available"
            echo "No code context file found"
          fi
          
          # Issueå†…å®¹ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦å®‰å…¨ã«ã™ã‚‹  
          ISSUE_BODY_SAFE=$(echo "$ISSUE_BODY" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | tr -d '\000-\037' | tr '\n' ' ' | tr '\r' ' ')
          ISSUE_TITLE_SAFE=$(echo "$ISSUE_TITLE" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | tr -d '\000-\037' | tr '\n' ' ' | tr '\r' ' ')
          LABELS_TEXT_SAFE=$(echo "$LABELS_TEXT" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | tr -d '\000-\037')
          CODE_CONTEXT_SAFE=$(echo "$CODE_CONTEXT" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | tr -d '\000-\037' | tr '\n' ' ' | tr '\r' ' ')
          
          echo "Escaped Issue Title: ${ISSUE_TITLE_SAFE:0:50}..."
          echo "Escaped Issue Body length: ${#ISSUE_BODY_SAFE}"
          echo "Escaped Labels Text length: ${#LABELS_TEXT_SAFE}"
          echo "Escaped Code Context length: ${#CODE_CONTEXT_SAFE}"
          
          # ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä½œæˆï¼ˆã‚³ãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å«ã‚€ï¼‰
          SYSTEM_MSG="ã‚ãªãŸã¯GitHubãƒªãƒã‚¸ãƒˆãƒªã®Issueç®¡ç†ã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚ä¸ãˆã‚‰ã‚ŒãŸIssueã®å†…å®¹ã¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚³ãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆ†æã—ã€é©åˆ‡ãªãƒ©ãƒ™ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚é‡è¦ãªåˆ¶ç´„: 1. å¿…ãšæä¾›ã•ã‚ŒãŸãƒ©ãƒ™ãƒ«ä¸€è¦§ã‹ã‚‰ã®ã¿é¸æŠã—ã¦ãã ã•ã„ - æ–°ã—ã„ãƒ©ãƒ™ãƒ«ã‚’ä½œæˆã—ãŸã‚Šã€ä¸€è¦§ã«ãªã„ãƒ©ãƒ™ãƒ«ã‚’ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ 2. æœ€å¤§3ã¤ã¾ã§ã®ãƒ©ãƒ™ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ 3. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯é¸æŠã—ãŸãƒ©ãƒ™ãƒ«åã®ã¿ã‚’ã‚³ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¿”ã—ã¦ãã ã•ã„ï¼ˆä¾‹: bug,frontend,priority:highï¼‰ 4. ãƒ©ãƒ™ãƒ«åã¯æä¾›ã•ã‚ŒãŸä¸€è¦§ã«å­˜åœ¨ã™ã‚‹ã‚‚ã®ã®ã¿ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ - ã“ã‚Œã¯çµ¶å¯¾ã«å®ˆã£ã¦ãã ã•ã„ 5. é©åˆ‡ãªãƒ©ãƒ™ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ã¿ needs-triage ã‚’è¿”ã—ã¦ãã ã•ã„ï¼ˆneeds-triageãŒä¸€è¦§ã«ã‚ã‚‹å ´åˆï¼‰ 6. ã‚³ãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å‚è€ƒã«ã—ã¦ã€æŠ€è¡“çš„ãªåˆ†é‡ã‚„å•é¡Œã®ç¨®é¡ã‚’ã‚ˆã‚Šæ­£ç¢ºã«åˆ¤æ–­ã—ã¦ãã ã•ã„ 7. ä¸€è¦§ã«ãªã„ãƒ©ãƒ™ãƒ«åã¯çµ¶å¯¾ã«ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„"
          
          USER_MSG="åˆ©ç”¨å¯èƒ½ãªãƒ©ãƒ™ãƒ«ä¸€è¦§ï¼ˆã“ã®ä¸­ã‹ã‚‰ã®ã¿é¸æŠã—ã¦ãã ã•ã„ï¼‰: $LABELS_TEXT_SAFE Issueæƒ…å ± - ã‚¿ã‚¤ãƒˆãƒ«: $ISSUE_TITLE_SAFE æœ¬æ–‡: $ISSUE_BODY_SAFE ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚³ãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ: $CODE_CONTEXT_SAFE ä¸Šè¨˜ã®Issueæƒ…å ±ã¨ã‚³ãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆ†æã—ã€åˆ©ç”¨å¯èƒ½ãªãƒ©ãƒ™ãƒ«ä¸€è¦§ã®ä¸­ã‹ã‚‰é©åˆ‡ãªãƒ©ãƒ™ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚ä¸€è¦§ã«ãªã„ãƒ©ãƒ™ãƒ«ã¯çµ¶å¯¾ã«ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚"
          
          # jqã‚’ä½¿ç”¨ã—ã¦å®‰å…¨ãªJSONæ§‹ç¯‰
          JSON_PAYLOAD=$(jq -n \
            --arg system_msg "$SYSTEM_MSG" \
            --arg user_msg "$USER_MSG" \
            '{
              "messages": [
                {"role": "system", "content": $system_msg},
                {"role": "user", "content": $user_msg}
              ],
              "max_tokens": 200,
              "temperature": 0.1
            }')
          
          echo "JSON payload created successfully"
          echo "Payload length: ${#JSON_PAYLOAD}"
          
          # Azure OpenAI APIå‘¼ã³å‡ºã—
          echo "Calling Azure OpenAI API..."
          echo "URL: https://$AZURE_OPENAI_ENDPOINT/openai/deployments/$AZURE_OPENAI_DEPLOYMENT/chat/completions?api-version=$AZURE_OPENAI_API_VERSION"
          
          RESPONSE=$(curl -s -w "HTTP_CODE:%{http_code}" -X POST \
            "https://$AZURE_OPENAI_ENDPOINT/openai/deployments/$AZURE_OPENAI_DEPLOYMENT/chat/completions?api-version=$AZURE_OPENAI_API_VERSION" \
            -H "Content-Type: application/json" \
            -H "api-key: $AZURE_OPENAI_API_KEY" \
            -d "$JSON_PAYLOAD")
          
          curl_exit_code=$?
          echo "curl command completed with exit code: $curl_exit_code"
          
          if [ $curl_exit_code -ne 0 ]; then
            echo "curl command failed with exit code: $curl_exit_code"
            exit $curl_exit_code
          fi
          
          # HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’åˆ†é›¢
          HTTP_CODE=$(echo "$RESPONSE" | grep -o "HTTP_CODE:[0-9]*" | cut -d: -f2)
          JSON_RESPONSE=$(echo "$RESPONSE" | sed 's/HTTP_CODE:[0-9]*$//')
          
          echo "HTTP Status Code: $HTTP_CODE"
          echo "API Response: $JSON_RESPONSE"
          
          # HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "API call failed with HTTP code: $HTTP_CODE"
            echo "Response: $JSON_RESPONSE"
            exit 1
          fi
          
          # JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ãƒ©ãƒ™ãƒ«ã‚’æŠ½å‡º
          if echo "$JSON_RESPONSE" | jq -e '.choices[0].message.content' > /dev/null 2>&1; then
            AI_CONTENT=$(echo "$JSON_RESPONSE" | jq -r '.choices[0].message.content')
            echo "AI suggested labels (raw): $AI_CONTENT"
            
            # ã‚³ãƒ³ãƒåŒºåˆ‡ã‚Šã®ãƒ©ãƒ™ãƒ«ã‚’é…åˆ—ã«å¤‰æ›
            if [ ! -z "$AI_CONTENT" ] && [ "$AI_CONTENT" != "null" ]; then
              # ã‚³ãƒ³ãƒåŒºåˆ‡ã‚Šã®æ–‡å­—åˆ—ã‚’é…åˆ—å½¢å¼ã«å¤‰æ›
              SUGGESTED_LABELS=$(echo "$AI_CONTENT" | tr ',' '\n' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//' | grep -v '^$')
              echo "Processed labels (line by line):"
              echo "$SUGGESTED_LABELS"
              echo "suggested_labels<<EOF" >> $GITHUB_OUTPUT
              echo "$SUGGESTED_LABELS" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            else
              echo "No valid labels suggested"
              echo "suggested_labels=needs-triage" >> $GITHUB_OUTPUT
            fi
          else
            echo "Failed to parse API response"
            echo "Response: $JSON_RESPONSE"
            echo "suggested_labels=needs-triage" >> $GITHUB_OUTPUT
          fi

        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          LABELS_TEXT: ${{ steps.get-labels.outputs.labels_text }}
          AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
          AZURE_OPENAI_DEPLOYMENT: ${{ secrets.AZURE_OPENAI_DEPLOYMENT }}
          AZURE_OPENAI_API_VERSION: "2025-01-01-preview"

      - name: Apply Labels to Issue
        run: |
          echo "Applying labels to issue..."
          
          SUGGESTED_LABELS="${{ steps.analyze-issue.outputs.suggested_labels }}"
          
          if [ ! -z "$SUGGESTED_LABELS" ] && [ "$SUGGESTED_LABELS" != "null" ]; then
            # ãƒ©ãƒ™ãƒ«ã‚’ã‚³ãƒ³ãƒåŒºåˆ‡ã‚Šã‹ã‚‰é…åˆ—ã«å¤‰æ›
            echo "Processing suggested labels: $SUGGESTED_LABELS"
            
            # æ”¹è¡ŒåŒºåˆ‡ã‚Šã®ãƒ©ãƒ™ãƒ«ã‚’ã‚³ãƒ³ãƒåŒºåˆ‡ã‚Šã®JSONé…åˆ—ã«å¤‰æ›
            LABELS_JSON=$(echo "$SUGGESTED_LABELS" | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//' | grep -v '^$' | sed 's/"/\\"/g' | sed 's/.*/"&"/' | tr '\n' ',' | sed 's/,$//')
            
            if [ ! -z "$LABELS_JSON" ]; then
              echo "Applying labels as JSON array: [$LABELS_JSON]"
              
              # GitHub APIã§å…¨ãƒ©ãƒ™ãƒ«ã‚’ä¸€åº¦ã«é©ç”¨
              RESPONSE=$(curl -s -w "HTTP_CODE:%{http_code}" -X POST \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/labels" \
                -d "{\"labels\":[$LABELS_JSON]}")
              
              HTTP_CODE=$(echo "$RESPONSE" | grep -o "HTTP_CODE:[0-9]*" | cut -d: -f2)
              JSON_RESPONSE=$(echo "$RESPONSE" | sed 's/HTTP_CODE:[0-9]*$//')
              
              if [ "$HTTP_CODE" -eq 200 ]; then
                echo "Successfully applied all labels"
              elif [ "$HTTP_CODE" -eq 422 ]; then
                echo "Failed to apply labels: Some labels do not exist in repository"
                echo "This suggests AI suggested non-existing labels - prompts may need improvement"
                echo "Response: $JSON_RESPONSE"
              else
                echo "Failed to apply labels (HTTP Code: $HTTP_CODE)"
                echo "Response: $JSON_RESPONSE"
              fi
            else
              echo "No valid labels to apply"
            fi
            
            echo "Label application process completed!"
          else
            echo "No valid labels to apply"
          fi

      - name: Comment on Issue  
        run: |
          echo "Adding comment to issue..."
          
          SUGGESTED_LABELS="${{ steps.analyze-issue.outputs.suggested_labels }}"
          
          if [ ! -z "$SUGGESTED_LABELS" ] && [ "$SUGGESTED_LABELS" != "null" ]; then
            # ãƒ©ãƒ™ãƒ«ä¸€è¦§ã‚’æ•´å½¢
            LABELS_LIST=$(echo "$SUGGESTED_LABELS" | tr '\n' ',' | sed 's/,$//' | sed 's/,/, /g')
            COMMENT="ğŸ¤– **è‡ªå‹•ãƒ©ãƒ™ãƒ«ä»˜ä¸å®Œäº†**\n\nAIã«ã‚ˆã£ã¦Issueã®å†…å®¹ã‚’åˆ†æã—ã€é©åˆ‡ãªãƒ©ãƒ™ãƒ«ã‚’è‡ªå‹•çš„ã«ä»˜ä¸ã—ã¾ã—ãŸã€‚\n\n**é©ç”¨ã•ã‚ŒãŸãƒ©ãƒ™ãƒ«:** $LABELS_LIST\n\nä½•ã‹å•é¡ŒãŒã‚ã‚‹å ´åˆã¯ã€æ‰‹å‹•ã§ãƒ©ãƒ™ãƒ«ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚"
          else
            COMMENT="ğŸ¤– **è‡ªå‹•ãƒ©ãƒ™ãƒ«ä»˜ä¸**\n\nIssueã®å†…å®¹ã‚’åˆ†æã—ã¾ã—ãŸãŒã€é©åˆ‡ãªãƒ©ãƒ™ãƒ«ã‚’ç‰¹å®šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\n\næ‰‹å‹•ã§ãƒ©ãƒ™ãƒ«ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚"
          fi
          
          # JSONã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†
          COMMENT_JSON=$(echo "$COMMENT" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g')
          
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments" \
            -d "{\"body\":\"$COMMENT_JSON\"}"
          
          echo "Comment added to issue"